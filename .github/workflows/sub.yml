name: Run subs-check, Commit all.yaml, and Repeat

on:
  push:
    branches:
      - main  # 当你向 main 分支推送时触发，可以根据需要修改为其他分支
  schedule:
    - cron: '0 */2 * * *'  # 每两个小时执行一次，可以根据需求调整时间间隔
  workflow_dispatch:  # 允许手动触发工作流

jobs:
  build:
    runs-on: ubuntu-latest  # 使用 GitHub 提供的 Linux 环境
    timeout-minutes: 120    # 设置最大执行时间为 2 小时

    steps:
    - name: Checkout code
      uses: actions/checkout@v2  # 检出当前仓库的代码，确保可以访问上传的二进制和配置文件

    - name: Give execute permissions to subs-check binary
      run: |
        chmod +x ./subs-check  # 给上传的二进制文件添加执行权限

    - name: Run subs-check
      run: |
        nohup ./subs-check -f ./config.yaml &  # 启动 subs-check 程序并在后台运行

    - name: Wait for subs-check to generate all.yaml
      run: |
        # 等待检测完成并生成 all.yaml 文件（最多 2 小时）
        timeout 2h bash -c 'while [ ! -f ./all.yaml ]; do sleep 10; done'  # 如果 2 小时内没生成，就超时

    - name: Commit the generated all.yaml to repository
      run: |
        if [ -f ./all.yaml ]; then
          git config --global user.name "github-actions[bot]"  # 设置提交用户名
          git config --global user.email "github-actions[bot]@users.noreply.github.com"  # 设置提交邮箱
          git add ./all.yaml  # 将 all.yaml 添加到 git 索引
          git commit -m "Update all.yaml after subs-check run"  # 提交文件
          git push origin main  # 推送文件到 GitHub 仓库的 main 分支
        else
          echo "No all.yaml generated, skipping commit."
        fi

    - name: Stop subs-check process (if running)
      run: |
        # 查找并停止 subs-check 进程
        pkill -f subs-check || echo "No subs-check process to stop"
